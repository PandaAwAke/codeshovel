{
  "origin": "codeshovel",
  "repositoryName": "elasticsearch",
  "repositoryPath": "/home/ncbradley/codeshovel-repos/elasticsearch/.git",
  "startCommitName": "7c0fc209bf78e4824ca1f232b84a1dab22bc2dfa",
  "sourceFileName": "MinDocQuery.java",
  "functionName": "createWeight",
  "functionId": "createWeight___searcher-IndexSearcher__needsScores-boolean__boost-float",
  "sourceFilePath": "server/src/main/java/org/apache/lucene/queries/MinDocQuery.java",
  "functionStartLine": 79,
  "functionEndLine": 106,
  "changeHistory": [
    "99f88f15c5febbca2d13b5b5fda27b844153bf1a",
    "996990ad1f68d25a219364109e4cafde9bd8a6bb",
    "1cd5e3413d4af43aaff7ad643cc5d13e8e1458a8",
    "7ab3d5d04a7c6dfef084e49587a81f7334a85cb4",
    "4632661bc71bb22fc577df476e70e9dfabaaae66",
    "5d9fb2e8a612d67e4cb9ef29fcd86befa4f941d3",
    "78c2f1063ac4a38943ea53fdd646cdb5646362f4",
    "15a62448343fd24f8e63f43b1e4b16f50005e4a5",
    "22bba91a160d306b14588e897cf0c34423a58da3"
  ],
  "changeHistoryShort": {
    "99f88f15c5febbca2d13b5b5fda27b844153bf1a": "Yfilerename",
    "996990ad1f68d25a219364109e4cafde9bd8a6bb": "Ybodychange",
    "1cd5e3413d4af43aaff7ad643cc5d13e8e1458a8": "Ybodychange",
    "7ab3d5d04a7c6dfef084e49587a81f7334a85cb4": "Ybodychange",
    "4632661bc71bb22fc577df476e70e9dfabaaae66": "Ymultichange(Yparameterchange,Ybodychange)",
    "5d9fb2e8a612d67e4cb9ef29fcd86befa4f941d3": "Ybodychange",
    "78c2f1063ac4a38943ea53fdd646cdb5646362f4": "Ymultichange(Ymovefromfile,Ybodychange)",
    "15a62448343fd24f8e63f43b1e4b16f50005e4a5": "Yfilerename",
    "22bba91a160d306b14588e897cf0c34423a58da3": "Yintroduced"
  },
  "changeHistoryDetails": {
    "99f88f15c5febbca2d13b5b5fda27b844153bf1a": {
      "type": "Yfilerename",
      "commitMessage": "Rename core module to server (#28180)\n\nThis is related to #27933. It renames the core module to server. This is\r\nthe first step towards introducing an elasticsearch-core jar.",
      "commitDate": 1515695443000,
      "commitName": "99f88f15c5febbca2d13b5b5fda27b844153bf1a",
      "commitAuthor": "Tim Brooks",
      "commitDateOld": 1515688270000,
      "commitNameOld": "7d0eb3292b8f8ba27ef50dbbf38783dc68c70728",
      "commitAuthorOld": "Martijn van Groningen",
      "daysBetweenCommits": 0.08,
      "commitsBetweenForRepo": 1,
      "commitsBetweenForFile": 1,
      "diff": ""
    },
    "996990ad1f68d25a219364109e4cafde9bd8a6bb": {
      "type": "Ybodychange",
      "commitMessage": "Upgrade to lucene-7.2.0-snapshot-8c94404. (#27496)\n\nThe main highlight of this new snapshot is that it introduces the opportunity\r\nfor queries to opt out of caching. In case a query opts out of caching, not only\r\nwill it never be cached, but also no compound query that wraps it will be\r\ncached.",
      "commitDate": 1511877162000,
      "commitName": "996990ad1f68d25a219364109e4cafde9bd8a6bb",
      "commitAuthor": "Adrien Grand",
      "commitDateOld": 1501147160000,
      "commitNameOld": "1cd5e3413d4af43aaff7ad643cc5d13e8e1458a8",
      "commitAuthorOld": "Adrien Grand",
      "daysBetweenCommits": 124.19,
      "commitsBetweenForRepo": 878,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,19 +1,28 @@\n     public Weight createWeight(IndexSearcher searcher, boolean needsScores, float boost) throws IOException {\n         if (readerId \u003d\u003d null) {\n             throw new IllegalStateException(\"Rewrite first\");\n         } else if (Objects.equals(searcher.getIndexReader().getContext().id(), readerId) \u003d\u003d false) {\n             throw new IllegalStateException(\"Executing against a different reader than the query has been rewritten against\");\n         }\n         return new ConstantScoreWeight(this, boost) {\n             @Override\n             public Scorer scorer(LeafReaderContext context) throws IOException {\n                 final int maxDoc \u003d context.reader().maxDoc();\n                 if (context.docBase + maxDoc \u003c\u003d minDoc) {\n                     return null;\n                 }\n                 final int segmentMinDoc \u003d Math.max(0, minDoc - context.docBase);\n                 final DocIdSetIterator disi \u003d new MinDocIterator(segmentMinDoc, maxDoc);\n                 return new ConstantScoreScorer(this, score(), disi);\n             }\n+\n+            @Override\n+            public boolean isCacheable(LeafReaderContext ctx) {\n+                // Let\u0027s not cache this query, the cached iterator would use more memory\n+                // and be slower anyway.\n+                // Also, matches in a given segment depend on the other segments, which\n+                // makes it a bad candidate for per-segment caching.\n+                return false;\n+            }\n         };\n     }\n\\ No newline at end of file\n"
    },
    "1cd5e3413d4af43aaff7ad643cc5d13e8e1458a8": {
      "type": "Ybodychange",
      "commitMessage": "Caching a MinDocQuery can lead to wrong results. (#25909)\n\nQueries are supposed to be cacheable per segment, yet matches of this query\r\nalso depend on how many documents exist on previous segments.\r\n",
      "commitDate": 1501147160000,
      "commitName": "1cd5e3413d4af43aaff7ad643cc5d13e8e1458a8",
      "commitAuthor": "Adrien Grand",
      "commitDateOld": 1497252810000,
      "commitNameOld": "7ab3d5d04a7c6dfef084e49587a81f7334a85cb4",
      "commitAuthorOld": "Jim Ferenczi",
      "daysBetweenCommits": 45.07,
      "commitsBetweenForRepo": 499,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,14 +1,19 @@\n     public Weight createWeight(IndexSearcher searcher, boolean needsScores, float boost) throws IOException {\n+        if (readerId \u003d\u003d null) {\n+            throw new IllegalStateException(\"Rewrite first\");\n+        } else if (Objects.equals(searcher.getIndexReader().getContext().id(), readerId) \u003d\u003d false) {\n+            throw new IllegalStateException(\"Executing against a different reader than the query has been rewritten against\");\n+        }\n         return new ConstantScoreWeight(this, boost) {\n             @Override\n             public Scorer scorer(LeafReaderContext context) throws IOException {\n                 final int maxDoc \u003d context.reader().maxDoc();\n                 if (context.docBase + maxDoc \u003c\u003d minDoc) {\n                     return null;\n                 }\n                 final int segmentMinDoc \u003d Math.max(0, minDoc - context.docBase);\n                 final DocIdSetIterator disi \u003d new MinDocIterator(segmentMinDoc, maxDoc);\n                 return new ConstantScoreScorer(this, score(), disi);\n             }\n         };\n     }\n\\ No newline at end of file\n"
    },
    "7ab3d5d04a7c6dfef084e49587a81f7334a85cb4": {
      "type": "Ybodychange",
      "commitMessage": "Speed up sorted scroll when the index sort matches the search sort (#25138)\n\nSorted scroll search can use early termination when the index sort matches the scroll search sort.\r\nThe optimization can be done after the first query (which still needs to collect all documents)\r\nby applying a query that only matches documents that are greater than the last doc retrieved in the previous request.\r\nSince the index is sorted, retrieving the list of documents that are greater than the last doc\r\nonly requires a binary search on each segment.\r\nThis change introduces this new query called `SortedSearchAfterDocQuery` and apply it when possible.\r\nScrolls with this optimization will search all documents on the first request and then will early terminate each segment\r\nafter $size doc for any subsequent requests.\r\n\r\nRelates #6720",
      "commitDate": 1497252810000,
      "commitName": "7ab3d5d04a7c6dfef084e49587a81f7334a85cb4",
      "commitAuthor": "Jim Ferenczi",
      "commitDateOld": 1492521441000,
      "commitNameOld": "4632661bc71bb22fc577df476e70e9dfabaaae66",
      "commitAuthorOld": "Adrien Grand",
      "daysBetweenCommits": 54.76,
      "commitsBetweenForRepo": 741,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,48 +1,14 @@\n     public Weight createWeight(IndexSearcher searcher, boolean needsScores, float boost) throws IOException {\n         return new ConstantScoreWeight(this, boost) {\n             @Override\n             public Scorer scorer(LeafReaderContext context) throws IOException {\n                 final int maxDoc \u003d context.reader().maxDoc();\n                 if (context.docBase + maxDoc \u003c\u003d minDoc) {\n                     return null;\n                 }\n                 final int segmentMinDoc \u003d Math.max(0, minDoc - context.docBase);\n-                final DocIdSetIterator disi \u003d new DocIdSetIterator() {\n-\n-                    int doc \u003d -1;\n-\n-                    @Override\n-                    public int docID() {\n-                        return doc;\n-                    }\n-\n-                    @Override\n-                    public int nextDoc() throws IOException {\n-                        return advance(doc + 1);\n-                    }\n-\n-                    @Override\n-                    public int advance(int target) throws IOException {\n-                        assert target \u003e doc;\n-                        if (doc \u003d\u003d -1) {\n-                            // skip directly to minDoc\n-                            doc \u003d Math.max(target, segmentMinDoc);\n-                        } else {\n-                            doc \u003d target;\n-                        }\n-                        if (doc \u003e\u003d maxDoc) {\n-                            doc \u003d NO_MORE_DOCS;\n-                        }\n-                        return doc;\n-                    }\n-\n-                    @Override\n-                    public long cost() {\n-                        return maxDoc - segmentMinDoc;\n-                    }\n-\n-                };\n+                final DocIdSetIterator disi \u003d new MinDocIterator(segmentMinDoc, maxDoc);\n                 return new ConstantScoreScorer(this, score(), disi);\n             }\n         };\n     }\n\\ No newline at end of file\n"
    },
    "4632661bc71bb22fc577df476e70e9dfabaaae66": {
      "type": "Ymultichange(Yparameterchange,Ybodychange)",
      "commitMessage": "Upgrade to a Lucene 7 snapshot (#24089)\n\nWe want to upgrade to Lucene 7 ahead of time in order to be able to check whether it causes any trouble to Elasticsearch before Lucene 7.0 gets released. From a user perspective, the main benefit of this upgrade is the enhanced support for sparse fields, whose resource consumption is now function of the number of docs that have a value rather than the total number of docs in the index.\r\n\r\nSome notes about the change:\r\n - it includes the deprecation of the `disable_coord` parameter of the `bool` and `common_terms` queries: Lucene has removed support for coord factors\r\n - it includes the deprecation of the `index.similarity.base` expert setting, since it was only useful to configure coords and query norms, which have both been removed\r\n - two tests have been marked with `@AwaitsFix` because of #23966, which we intend to address after the merge",
      "commitDate": 1492521441000,
      "commitName": "4632661bc71bb22fc577df476e70e9dfabaaae66",
      "commitAuthor": "Adrien Grand",
      "subchanges": [
        "Yparameterchange",
        "Ybodychange"
      ]
    },
    "5d9fb2e8a612d67e4cb9ef29fcd86befa4f941d3": {
      "type": "Ybodychange",
      "commitMessage": "Upgrade to lucene-5.3.0.\n\nFrom a user perspective, the main benefit from this upgrade is that the new\nLucene53Codec has disk-based norms. The elasticsearch directory has been fixed\nto load these norms through mmap instead of nio.\n\nOther changes include the removal of `max_thread_states`, the fact that\nPhraseQuery and BooleanQuery are now immutable, and that deleted docs are now\napplied on top of the Scorer API.\n\nThis change introduces a couple of `AwaitsFix`s but I don\u0027t think it should\nhold us from merging.\n",
      "commitDate": 1441101525000,
      "commitName": "5d9fb2e8a612d67e4cb9ef29fcd86befa4f941d3",
      "commitAuthor": "Adrien Grand",
      "commitDateOld": 1440064319000,
      "commitNameOld": "78c2f1063ac4a38943ea53fdd646cdb5646362f4",
      "commitAuthorOld": "Adrien Grand",
      "daysBetweenCommits": 12.0,
      "commitsBetweenForRepo": 171,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,54 +1,48 @@\n     public Weight createWeight(IndexSearcher searcher, boolean needsScores) throws IOException {\n         return new ConstantScoreWeight(this) {\n             @Override\n-            public Scorer scorer(LeafReaderContext context, final Bits acceptDocs) throws IOException {\n+            public Scorer scorer(LeafReaderContext context) throws IOException {\n                 final int maxDoc \u003d context.reader().maxDoc();\n                 if (context.docBase + maxDoc \u003c\u003d minDoc) {\n                     return null;\n                 }\n                 final int segmentMinDoc \u003d Math.max(0, minDoc - context.docBase);\n                 final DocIdSetIterator disi \u003d new DocIdSetIterator() {\n \n                     int doc \u003d -1;\n \n                     @Override\n                     public int docID() {\n                         return doc;\n                     }\n \n                     @Override\n                     public int nextDoc() throws IOException {\n                         return advance(doc + 1);\n                     }\n \n                     @Override\n                     public int advance(int target) throws IOException {\n                         assert target \u003e doc;\n                         if (doc \u003d\u003d -1) {\n                             // skip directly to minDoc\n                             doc \u003d Math.max(target, segmentMinDoc);\n                         } else {\n                             doc \u003d target;\n                         }\n-                        while (doc \u003c maxDoc) {\n-                            if (acceptDocs \u003d\u003d null || acceptDocs.get(doc)) {\n-                                break;\n-                            }\n-                            doc +\u003d 1;\n-                        }\n                         if (doc \u003e\u003d maxDoc) {\n                             doc \u003d NO_MORE_DOCS;\n                         }\n                         return doc;\n                     }\n \n                     @Override\n                     public long cost() {\n                         return maxDoc - segmentMinDoc;\n                     }\n \n                 };\n                 return new ConstantScoreScorer(this, score(), disi);\n             }\n         };\n     }\n\\ No newline at end of file\n"
    },
    "78c2f1063ac4a38943ea53fdd646cdb5646362f4": {
      "type": "Ymultichange(Ymovefromfile,Ybodychange)",
      "commitMessage": "Optimize sorted scroll when sorting by `_doc`.\n\nThis change means that we will be able to remove the `SCAN` search type in 3.0\nand recommend users to use sorted scrolls instead.\n",
      "commitDate": 1440064319000,
      "commitName": "78c2f1063ac4a38943ea53fdd646cdb5646362f4",
      "commitAuthor": "Adrien Grand",
      "subchanges": [
        "Ymovefromfile",
        "Ybodychange"
      ]
    },
    "15a62448343fd24f8e63f43b1e4b16f50005e4a5": {
      "type": "Yfilerename",
      "commitMessage": "create core module\n",
      "commitDate": 1433502723000,
      "commitName": "15a62448343fd24f8e63f43b1e4b16f50005e4a5",
      "commitAuthor": "Simon Willnauer",
      "commitDateOld": 1433502668000,
      "commitNameOld": "7ccc193a666e2ae888e7ac93d677a2143e5e07c3",
      "commitAuthorOld": "Simon Willnauer",
      "daysBetweenCommits": 0.0,
      "commitsBetweenForRepo": 1,
      "commitsBetweenForFile": 1,
      "diff": ""
    },
    "22bba91a160d306b14588e897cf0c34423a58da3": {
      "type": "Yintroduced",
      "commitMessage": "Search: Make SCAN faster.\n\nWhen scrolling, SCAN previously collected documents until it reached where it\nhad stopped on the previous iteration. This makes pagination slower and slower\nas you request deep pages. With this change, SCAN now directly jumps to the\ndoc ID where is had previously stopped.\n",
      "commitDate": 1431706990000,
      "commitName": "22bba91a160d306b14588e897cf0c34423a58da3",
      "commitAuthor": "Adrien Grand"
    }
  }
}